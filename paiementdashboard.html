<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Paiement — AllergoZymeProtect</title>
<style>
  :root{--gold:#d4af37;--gold-deep:#b68f1e;--white:#fff;--gold-25:rgba(212,175,55,.25)}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:#fff;color:var(--gold-deep);display:grid;place-items:center;min-height:100vh}
  .card{max-width:560px;width:92%;border:1px solid var(--gold-25);border-radius:18px;padding:24px;box-shadow:0 18px 46px var(--gold-25)}
  h1{margin:0 0 8px;text-align:center}
  p{text-align:center}
</style>
</head>
<body>
  <div class="card">
    <h1>Paiement de l’abonnement</h1>
    <p>Abonnement annuel 20€ via PayPal.</p>
    <div id="paypal-button-container-P-9NN80675AT539804WNDZ4JNY" style="margin-top:16px"></div>
  </div>

  <script src="https://www.paypal.com/sdk/js?client-id=Afl7FOJLfCDl_Lhe7B2kkJ5QDPsB6JaS3hFBoo2IZ6hgd1i5-CYGjEylX-aVrDQg62tlbEegW9aCtpcZ&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_URL = "https://TON_PROJET.supabase.co";
    const SUPABASE_ANON_KEY = "TA_CLE_PUBLIC";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let restaurant = null;
    async function loadRestaurant(){
      const { data: sess } = await supabase.auth.getSession();
      if(!sess?.session){ window.location.href="identification.html"; return; }
      const email = sess.session.user.email;
      const { data, error } = await supabase.from('restaurants').select('*').eq('email', email).single();
      if(error || !data){ alert("Profil introuvable."); return; }
      restaurant = data;
    }
    await loadRestaurant();

    paypal.Buttons({
      style:{shape:'rect', color:'gold', layout:'vertical', label:'subscribe'},
      createSubscription:(data,actions)=>actions.subscription.create({ plan_id:'P-9NN80675AT539804WNDZ4JNY' }),
      onApprove: async (data,actions)=>{
        await supabase.from('restaurants').update({
          paiement:true, paypal_subscription_id:data.subscriptionID
        }).eq('id', restaurant.id);
        alert("Paiement validé. Abonnement actif.");
        window.location.href = "dashboard.html";
      }
    }).render('#paypal-button-container-P-9NN80675AT539804WNDZ4JNY');
  </script>
</body>
</html>

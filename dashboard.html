<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AllergoZymeProtect — Tableau de bord</title>
  <meta name="description" content="Espace pro : QR général (x3), QR par table, paiement, statut abonnement, plan de salle. Blanc & doré, premium." />
  <link rel="icon" href="assets/favicon.ico" />
  <style>
    :root{
      --gold:#d4af37; --gold-deep:#b68f1e; --white:#ffffff;
      --gold-08:rgba(212,175,55,0.08); --gold-10:rgba(212,175,55,0.10);
      --gold-18:rgba(212,175,55,0.18); --gold-25:rgba(212,175,55,0.25);
      --gold-35:rgba(212,175,55,0.35); --gold-45:rgba(212,175,55,0.45);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--white);color:var(--gold-deep);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{background:linear-gradient(180deg,var(--white) 0%,#fff9e7 60%,var(--white) 100%)}

    header{
      position:sticky;top:0;z-index:30;display:flex;align-items:center;justify-content:space-between;
      padding:16px 22px;border-bottom:1px solid var(--gold-25);backdrop-filter:blur(10px);
      background:rgba(255,255,255,.86);box-shadow:0 6px 24px var(--gold-10)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .brand img{width:44px;height:44px;filter:drop-shadow(0 0 12px var(--gold-25))}
    .brand h1{
      margin:0;font-size:1.05rem;letter-spacing:.14em;text-transform:uppercase;
      background:linear-gradient(90deg,var(--gold-deep),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent
    }
    .top-actions{display:flex;align-items:center;gap:10px}
    .btn{border:1px solid var(--gold-deep);padding:10px 16px;border-radius:999px;background:var(--gold-deep);color:#fff;font-weight:700;text-decoration:none;cursor:pointer;transition:transform .2s, box-shadow .2s}
    .btn:hover{transform:translateY(-2px);box-shadow:0 10px 24px var(--gold-25)}
    .btn-ghost{background:#fff;color:var(--gold-deep)}
    .status-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--gold-deep);margin-left:6px}
    .status-red{background:#c94141;box-shadow:0 0 10px rgba(201,65,65,.4)}
    .status-green{background:#3aa357;box-shadow:0 0 10px rgba(58,163,87,.4)}

    main{max-width:1280px;margin:0 auto;padding:24px 16px 80px}
    .card{background:#fff;border:1px solid var(--gold-25);border-radius:22px;padding:20px;box-shadow:0 14px 36px var(--gold-10);margin:16px 0;position:relative;overflow:hidden}
    .card::after{content:"";position:absolute;inset:-1px;border-radius:22px;background:radial-gradient(900px 160px at 20% -10%, var(--gold-10), transparent 40%);pointer-events:none}
    h2{margin:0 0 10px;text-align:center;background:linear-gradient(90deg,var(--gold-deep),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .muted{opacity:.92}
    .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center}
    .input{padding:12px 14px;border:1px solid var(--gold-25);border-radius:12px;font-size:1rem;min-width:180px;background:#fff}
    .color{width:52px;height:44px;padding:0;border-radius:12px;border:1px solid var(--gold-25);background:#fff}
    .note{font-size:.92rem;opacity:.9}
    .grid{display:grid;gap:18px}
    .grid-2{grid-template-columns:1.1fr .9fr}
    @media (max-width:1100px){.grid-2{grid-template-columns:1fr}}

    .overlay-locked{
      position:fixed; inset:64px 0 0 0; z-index:20; display:none;
      background:linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.92));
      backdrop-filter: blur(6px);
    }
    .overlay-locked.active{display:flex; align-items:center; justify-content:center}
    .overlay-locked .box{
      border:2px dashed var(--gold-45); border-radius:18px; padding:22px; background:#fff; max-width:720px; box-shadow:0 10px 32px var(--gold-18); text-align:center
    }
    .overlay-locked h3{margin:0 0 8px}
    .overlay-locked p{margin:0 0 12px}
    .overlay-locked .btn{margin-top:6px}

    .qr-triple{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width:1000px){.qr-triple{grid-template-columns:1fr}}
    .qr-card{border:1px solid var(--gold-25);border-radius:18px;padding:14px;text-align:center;box-shadow:0 10px 24px var(--gold-10);background:#fff}
    .qr-wrap{display:grid;place-items:center}
    .qr-logo-under{margin-top:8px;display:flex;align-items:center;justify-content:center;gap:8px}
    .qr-logo-under img{width:28px;height:28px;object-fit:contain;filter:drop-shadow(0 0 6px var(--gold-18))}
    .qr-logo-under .brand-small{font-weight:800;letter-spacing:.08em}

    /* Mini-plan (localStorage uniquement pour le placement visuel) */
    .floor{
      min-height:420px;border:1px dashed var(--gold-45);border-radius:18px;background:linear-gradient(180deg,#fff,rgba(212,175,55,.06));
      position:relative; overflow:hidden
    }
    .grid-bg{
      position:absolute; inset:0; background-image:
        linear-gradient(to right, rgba(212,175,55,.18) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(212,175,55,.18) 1px, transparent 1px);
      background-size:40px 40px; pointer-events:none; opacity:.35
    }
    .table-dot{
      position:absolute; width:96px; height:96px; display:grid; place-items:center; color:var(--gold-deep);
      background:#fff; border:2px solid var(--gold-deep); border-radius:16px; cursor:move; user-select:none;
      box-shadow:0 14px 28px var(--gold-10)
    }
    .table-dot.round{border-radius:50%}
    .table-dot .label{font-weight:800}
    .dragging{opacity:.8; transform:scale(1.02)}

    .tables{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-top:12px}
    .table-card{border:1px solid var(--gold-25);border-radius:18px;padding:14px;text-align:center;box-shadow:0 10px 24px var(--gold-10);transition:transform .2s;background:#fff}
    .table-card:hover{transform:translateY(-3px)}
    .table-shape{display:inline-flex;align-items:center;justify-content:center;width:96px;height:96px;border:2px solid var(--gold-deep);margin-bottom:8px;font-weight:800;color:var(--gold-deep);background:#fff}
    .round{border-radius:50%}
    .table-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .mini{padding:8px 10px;border-radius:10px;font-weight:700;border:1px solid var(--gold-25);background:#fff;cursor:pointer}
    .mini:hover{box-shadow:0 8px 18px var(--gold-10)}
    .danger{background:#c94141;color:#fff;border-color:#c94141}
    .soft{background:var(--gold);color:#333;border-color:var(--gold)}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="assets/logo.png" alt="logo" />
      <h1>AllergoZyme Protect</h1>
    </div>
    <div class="top-actions">
      <a class="btn btn-ghost" href="archive.html">Archive</a>
      <a id="payBtn" class="btn">Payer l’abonnement</a>
      <div id="payCircle" class="status-dot status-red" title="Statut abonnement"></div>
    </div>
  </header>

  <!-- Overlay de blocage total si abonnement inactif -->
  <div id="lockOverlay" class="overlay-locked">
    <div class="box">
      <h3>Abonnement inactif</h3>
      <p class="muted">Votre abonnement annuel est inactif. Aucune fonctionnalité n’est accessible et les QR ne sont pas utilisables.</p>
      <div id="paypalZone" class="row" style="margin-top:10px">
        <div id="paypal-button-container-P-9NN80675AT539804WNDZ4JNY"></div>
      </div>
      <button id="retryStatus" class="btn btn-ghost" style="margin-top:10px">Rafraîchir le statut</button>
    </div>
  </div>

  <main>
    <!-- Statut -->
    <section class="card" id="statusCard">
      <h2>Statut de l’abonnement</h2>
      <p class="muted" id="statusText" style="text-align:center">
        Vérification en cours…
      </p>
    </section>

    <!-- QR général x3 -->
    <section class="card" id="cardGeneral">
      <h2>QR Code Général (x3)</h2>
      <p class="note" style="text-align:center">QR unique pour l’établissement — choisissez la couleur. Le logo AllergoZyme est affiché en dessous pour signature visuelle.</p>
      <div class="row" style="justify-content:center;margin-top:8px">
        <label>Couleur :</label>
        <input type="color" id="generalColor" class="color" value="#b68f1e" />
        <button id="regenGeneral" class="btn">Actualiser</button>
        <button id="saveGeneral" class="btn btn-ghost">Sauvegarder la couleur</button>
      </div>
      <div class="qr-triple">
        <div class="qr-card">
          <div class="qr-wrap"><canvas id="generalCanvasL" width="260" height="260" aria-label="QR code général (gauche)"></canvas></div>
          <div class="qr-logo-under">
            <img src="assets/logo.png" alt="AllergoZyme logo" />
            <span class="brand-small">AllergoZyme</span>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="downloadGeneralL" class="btn btn-ghost">Télécharger</button>
          </div>
        </div>
        <div class="qr-card">
          <div class="qr-wrap"><canvas id="generalCanvasC" width="260" height="260" aria-label="QR code général (centre)"></canvas></div>
          <div class="qr-logo-under">
            <img src="assets/logo.png" alt="AllergoZyme logo" />
            <span class="brand-small">AllergoZyme</span>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="downloadGeneralC" class="btn btn-ghost">Télécharger</button>
          </div>
        </div>
        <div class="qr-card">
          <div class="qr-wrap"><canvas id="generalCanvasR" width="260" height="260" aria-label="QR code général (droite)"></canvas></div>
          <div class="qr-logo-under">
            <img src="assets/logo.png" alt="AllergoZyme logo" />
            <span class="brand-small">AllergoZyme</span>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="downloadGeneralR" class="btn btn-ghost">Télécharger</button>
          </div>
        </div>
      </div>
    </section>

    <!-- QR tables + plan -->
    <section class="grid grid-2">
      <div class="card" id="cardFloor">
        <h2>Plan de salle (visuel)</h2>
        <p class="note" style="text-align:center">Placez vos tables (drag & drop). Le plan est local à votre navigateur.</p>
        <div class="row" style="margin-bottom:8px">
          <input id="tableName" class="input" placeholder="Nom / n° de table" />
          <select id="tableShape" class="input">
            <option value="round">Rond</option>
            <option value="square">Carré</option>
          </select>
          <input id="tableColor" type="color" class="color" value="#d4af37" />
          <button id="addTable" class="btn">Créer la table + QR</button>
        </div>
        <div class="floor" id="floor">
          <div class="grid-bg"></div>
        </div>
      </div>

      <div class="card" id="cardTables">
        <h2>QR par Table (liste)</h2>
        <div id="tablesContainer" class="tables"></div>
      </div>
    </section>
  </main>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=Afl7FOJLfCDl_Lhe7B2kkJ5QDPsB6JaS3hFBoo2IZ6hgd1i5-CYGjEylX-aVrDQg62tlbEegW9aCtpcZ&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>
  <!-- QRCode lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ---------- CONFIG SUPABASE ----------
    const SUPABASE_URL = "https://tmrraeutjrcsozijjbzm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcnJhZXV0anJjc296aWpqYnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA4NzIsImV4cCI6MjA3NjM3Njg3Mn0.015qUFsUyndsesz5RHGKWO1Ipoz7C3vcVZulACGmq0g";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---------- ELEMENTS ----------
    const payBtn = document.getElementById('payBtn');
    const payCircle = document.getElementById('payCircle');
    const statusText = document.getElementById('statusText');
    const lockOverlay = document.getElementById('lockOverlay');
    const retryStatus = document.getElementById('retryStatus');

    const generalColor  = document.getElementById('generalColor');
    const regenGeneral  = document.getElementById('regenGeneral');
    const saveGeneral   = document.getElementById('saveGeneral');
    const canvL = document.getElementById('generalCanvasL');
    const canvC = document.getElementById('generalCanvasC');
    const canvR = document.getElementById('generalCanvasR');
    const downloadGeneralL = document.getElementById('downloadGeneralL');
    const downloadGeneralC = document.getElementById('downloadGeneralC');
    const downloadGeneralR = document.getElementById('downloadGeneralR');

    const tableName  = document.getElementById('tableName');
    const tableShape = document.getElementById('tableShape');
    const tableColor = document.getElementById('tableColor');
    const addTable   = document.getElementById('addTable');
    const floor      = document.getElementById('floor');
    const tablesContainer = document.getElementById('tablesContainer');

    // ---------- ETAT ----------
    let session = null;
    let restaurant = null;
    let paymentActive = false;
    const adminMode = localStorage.getItem("adminMode") === "true"; // set true to bypass for tests

    // ---------- HELPERS ----------
    function setPaymentUI(active){
      paymentActive = active;
      if(active){
        payCircle.classList.remove('status-red'); payCircle.classList.add('status-green');
        statusText.textContent = "Abonnement actif. Toutes les fonctionnalités sont disponibles.";
        lockOverlay.classList.remove('active');
      }else{
        payCircle.classList.remove('status-green'); payCircle.classList.add('status-red');
        statusText.textContent = "Abonnement inactif. Le tableau de bord et les QR sont désactivés.";
        lockOverlay.classList.add('active');
      }
    }

    function downloadCanvasPNG(canvas, filename){
      const link = document.createElement('a');
      link.download = filename;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }

    async function drawQRCode(canvas, url, darkHex="#000000"){
      const QR = window.QRCode;
      const tmp = document.createElement('canvas');
      await QR.toCanvas(tmp, url, { color:{ dark:darkHex, light:"#ffffff" }, width:260, margin:1 });
      const ctx = canvas.getContext('2d');
      canvas.width = tmp.width; canvas.height = tmp.height + 50; // espace dessous pour logo
      // Dessine le QR
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(tmp, 0, 0);

      // Logo SOUS le QR (centré)
      const logo = new Image();
      logo.src = 'assets/logo.png';
      await new Promise(res => { logo.onload = res; logo.onerror = res; });
      const size = 28;
      const lx = (canvas.width - size)/2;
      const ly = tmp.height + (50 - size)/2;
      // pastille légère
      ctx.save();
      ctx.shadowColor = 'rgba(0,0,0,.08)';
      ctx.shadowBlur = 6;
      ctx.drawImage(logo, lx, ly, size, size);
      ctx.restore();
    }

    function baseScanUrl(params){
      const origin = window.location.origin;
      const url = new URL('signature.html', origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      return url.toString();
    }

    // ---------- SESSION + RESTAURANT ----------
    async function loadSessionAndRestaurant(){
      if (adminMode) {
        restaurant = {
          id: 'ADMIN-DEMO',
          email: 'admin@allergozyme.com',
          paiement: true,
          general_qr_color: '#b68f1e'
        };
        setPaymentUI(true);
        return;
      }

      const { data: sess } = await supabase.auth.getSession();
      session = sess?.session || null;
      if(!session){ window.location.href = "identification.html"; return; }

      const email = session.user.email;
      const { data, error } = await supabase.from('restaurants').select('*').eq('email', email).single();
      if(error || !data){ alert("Impossible de charger le profil restaurateur."); return; }
      restaurant = data;

      // statut paiement
      const active = !!restaurant.paiement;
      setPaymentUI(active);

      // couleur initiale
      if(restaurant.general_qr_color){ generalColor.value = restaurant.general_qr_color; }
    }

    // ---------- PAYPAL ----------
    payBtn.addEventListener('click', () => {
      if (adminMode) { alert("Mode Admin actif — paiement non requis."); return; }
      // scroll à la zone Paypal dans l'overlay (si verrouillé)
      lockOverlay.classList.add('active');
      const zone = document.getElementById('paypal-button-container-P-9NN80675AT539804WNDZ4JNY');
      if(zone){ zone.scrollIntoView({ behavior:'smooth', block:'center' }); }
    });

    retryStatus.addEventListener('click', async ()=>{
      await loadSessionAndRestaurant();
      await renderGeneralQR(); // pour rafraîchir affichage
      await loadTableList();
    });

    if (typeof paypal !== 'undefined') {
      paypal.Buttons({
        style:{ shape:'rect', color:'gold', layout:'vertical', label:'subscribe' },
        createSubscription:(data,actions)=>actions.subscription.create({ plan_id:'P-9NN80675AT539804WNDZ4JNY' }),
        onApprove: async (data) => {
          if(!adminMode && restaurant?.id){
            await supabase.from('restaurants').update({ paiement:true, paypal_subscription_id:data.subscriptionID }).eq('id', restaurant.id);
            restaurant.paiement = true;
          }
          setPaymentUI(true);
          alert("Paiement validé. Votre abonnement est actif.");
          await renderGeneralQR(true);
          await loadTableList();
        },
        onError: (err)=>{ console.error(err); alert("Erreur PayPal : " + err.message); }
      }).render('#paypal-button-container-P-9NN80675AT539804WNDZ4JNY');
    }

    // ---------- QR GENERAL (x3) ----------
    async function renderGeneralQR(save=false){
      // si abonnement inactif : ne pas afficher de QR
      if(!paymentActive && !adminMode){
        const placeholders = [canvL, canvC, canvR];
        placeholders.forEach(cv=>{
          const c = cv.getContext('2d');
          c.clearRect(0,0,cv.width,cv.height);
          c.fillStyle = '#fff';
          c.fillRect(0,0,cv.width,cv.height);
          c.fillStyle = '#b9b9b9';
          c.textAlign='center'; c.font='bold 14px ui-sans-serif';
          c.fillText('Abonnement inactif', cv.width/2, cv.height/2);
        });
        return;
      }

      const restId = restaurant?.id || "DEMO";
      const colorHex = generalColor.value || '#b68f1e';
      const url = baseScanUrl({ restaurant: restId, type:'general' });

      await Promise.all([
        drawQRCode(canvL, url, colorHex),
        drawQRCode(canvC, url, colorHex),
        drawQRCode(canvR, url, colorHex)
      ]);

      if (!adminMode && save && restaurant?.id) {
        await supabase.from('restaurants').update({ general_qr_color: colorHex }).eq('id', restaurant.id);

        // Optionnel : consigner/mettre à jour un enregistrement de QR général
        // (utile si tu veux une trace dans qr_codes)
        const { data: exist } = await supabase
          .from('qr_codes')
          .select('id')
          .eq('restaurant_id', restaurant.id)
          .eq('type', 'general')
          .limit(1);

        if (exist && exist.length) {
          await supabase.from('qr_codes')
            .update({ couleur: colorHex, url_qr: url })
            .eq('id', exist[0].id);
        } else {
          await supabase.from('qr_codes')
            .insert([{ restaurant_id: restaurant.id, type:'general', couleur: colorHex, forme:'carre', url_qr: url }]);
        }
      }
    }

    regenGeneral.addEventListener('click', async ()=>{ await renderGeneralQR(false); });
    saveGeneral.addEventListener('click', async ()=>{ if(!paymentActive && !adminMode) return; await renderGeneralQR(true); });
    downloadGeneralL.addEventListener('click', ()=> downloadCanvasPNG(canvL,'QR_General_Left.png'));
    downloadGeneralC.addEventListener('click', ()=> downloadCanvasPNG(canvC,'QR_General_Center.png'));
    downloadGeneralR.addEventListener('click', ()=> downloadCanvasPNG(canvR,'QR_General_Right.png'));

    // ---------- DRAG PLAN (local) ----------
    function layoutKey(){ return `layout_${restaurant?.id || 'DEMO'}`; }
    function loadFloorLayout(){
      const json = localStorage.getItem(layoutKey());
      return json ? JSON.parse(json) : []; // [{name,shape,color,x,y}]
    }
    function saveFloorLayout(layout){
      localStorage.setItem(layoutKey(), JSON.stringify(layout));
    }
    function makeDraggable(el, item){
      let startX, startY, origX, origY, dragging = false;
      el.addEventListener('pointerdown', (e)=>{
        dragging = true; el.classList.add('dragging');
        startX = e.clientX; startY = e.clientY;
        const rect = el.getBoundingClientRect();
        const parentRect = floor.getBoundingClientRect();
        origX = rect.left - parentRect.left; origY = rect.top - parentRect.top;
        el.setPointerCapture(e.pointerId);
      });
      el.addEventListener('pointermove', (e)=>{
        if(!dragging) return;
        const dx = e.clientX - startX, dy = e.clientY - startY;
        let nx = Math.max(0, Math.min(floor.clientWidth - el.offsetWidth, origX + dx));
        let ny = Math.max(0, Math.min(floor.clientHeight - el.offsetHeight, origY + dy));
        nx = Math.round(nx/40)*40; ny = Math.round(ny/40)*40;
        el.style.left = nx+'px'; el.style.top = ny+'px';
      });
      el.addEventListener('pointerup', ()=>{
        if(!dragging) return;
        dragging = false; el.classList.remove('dragging');
        const layout = loadFloorLayout();
        const i = layout.findIndex(t=>t.name===item.name);
        const nx = parseInt(el.style.left||'0'), ny = parseInt(el.style.top||'0');
        if(i>-1){ layout[i].x = nx; layout[i].y = ny; saveFloorLayout(layout); }
      });
    }
    function renderFloor(){
      floor.querySelectorAll('.table-dot').forEach(n=>n.remove());
      const layout = loadFloorLayout();
      layout.forEach(item=>{
        const dot = document.createElement('div');
        dot.className = 'table-dot' + (item.shape==='round'?' round':'');
        dot.style.left = (item.x||0) + 'px';
        dot.style.top  = (item.y||0) + 'px';
        dot.style.borderColor = item.color || '#d4af37';
        dot.innerHTML = `<div class="label">${item.name}</div>`;
        makeDraggable(dot, item);
        floor.appendChild(dot);
      });
    }

    // ---------- LISTE QR TABLES (via qr_codes) ----------
    async function loadTableList(){
      tablesContainer.innerHTML = '';

      if(!paymentActive && !adminMode){
        const muted = document.createElement('div');
        muted.className = 'note';
        muted.style.textAlign = 'center';
        muted.textContent = "Abonnement inactif — aucune table affichée.";
        tablesContainer.appendChild(muted);
        return;
      }

      // Lire dans qr_codes (type = table)
      const { data, error } = adminMode
        ? { data: loadFloorLayout().map(t=>({ id:t.name, table_nom:t.name, forme:(t.shape==='round'?'rond':'carre'), couleur:t.color, url_qr: baseScanUrl({ restaurant: restaurant?.id || 'DEMO', table: t.name }) })), error:null }
        : await supabase
            .from('qr_codes')
            .select('*')
            .eq('restaurant_id', restaurant.id)
            .eq('type', 'table')
            .order('created_at', { ascending:true });

      if(error){ console.warn(error); return; }
      for(const t of (data||[])){ await renderTableCard(t); }
    }

    async function renderTableCard(t){
      const card = document.createElement('div');
      card.className = 'table-card';

      // Visuel forme
      const shapeEl = document.createElement('div');
      const isRound = (t.forme === 'rond' || t.forme === 'round');
      shapeEl.className = 'table-shape '+(isRound?'round':'');
      shapeEl.style.borderColor = t.couleur || '#d4af37';
      shapeEl.textContent = t.table_nom || t.name || 'Table';
      card.appendChild(shapeEl);

      // Canvas QR
      const c = document.createElement('canvas');
      card.appendChild(c);

      const url = t.url_qr || baseScanUrl({ restaurant: restaurant?.id || 'DEMO', table: t.table_nom || t.name });
      const col = t.couleur || '#d4af37';
      await drawQRCode(c, url, col);

      // Actions
      const actions = document.createElement('div');
      actions.className = 'table-actions';

      const bDown = document.createElement('button');
      bDown.className='mini'; bDown.textContent='Télécharger';
      bDown.onclick = ()=> downloadCanvasPNG(c, `QR_${t.table_nom || t.name}.png`);

      const bRen  = document.createElement('button');
      bRen.className='mini soft'; bRen.textContent='Renommer';
      bRen.onclick = async ()=>{
        const nn = prompt("Nouveau nom de table :", t.table_nom || t.name); if(!nn) return;

        // Mise à jour local plan
        const layout = loadFloorLayout();
        const i = layout.findIndex(x=>x.name===(t.table_nom || t.name));
        if(i>-1){ layout[i].name = nn; saveFloorLayout(layout); renderFloor(); }

        // Mise à jour base
        if(!adminMode && restaurant?.id && t.id){
          const urlNew = baseScanUrl({ restaurant: restaurant.id, table: nn });
          await supabase.from('qr_codes').update({ table_nom: nn, url_qr: urlNew }).eq('id', t.id);
          await loadTableList();
        }else{
          await loadTableList();
        }
      };

      const bDel = document.createElement('button');
      bDel.className='mini danger'; bDel.textContent='Supprimer';
      bDel.onclick = async ()=>{
        if(!confirm("Supprimer cette table et son QR ?")) return;

        let layout = loadFloorLayout().filter(x=>x.name!==(t.table_nom || t.name));
        saveFloorLayout(layout); renderFloor(); card.remove();

        if(!adminMode && restaurant?.id && t.id){
          await supabase.from('qr_codes').delete().eq('id', t.id);
        }
      };

      actions.append(bDown,bRen,bDel);
      card.appendChild(actions);
      tablesContainer.appendChild(card);
    }

    // ---------- AJOUT TABLE ----------
    addTable.addEventListener('click', async ()=>{
      if(!paymentActive && !adminMode){ alert("Activez l’abonnement pour créer des QR."); return; }
      const name = (tableName.value||'').trim();
      if(!name){ tableName.focus(); return; }
      const shape = tableShape.value === 'round' ? 'rond':'carre';
      const color = tableColor.value || '#d4af37';

      // Ajout sur le plan (local)
      const layout = loadFloorLayout();
      if(layout.some(x=>x.name===name)){ alert("Ce nom de table existe déjà sur le plan."); return; }
      layout.push({ name, shape: (shape==='rond'?'round':'square'), color, x:40*(layout.length%6), y:40*(Math.floor(layout.length/6)) });
      saveFloorLayout(layout);
      renderFloor();

      // Ajout en base qr_codes
      const url = baseScanUrl({ restaurant: restaurant?.id || 'DEMO', table: name });
      if(!adminMode && restaurant?.id){
        const { error } = await supabase.from('qr_codes').insert([{
          restaurant_id: restaurant.id,
          type: 'table',
          table_nom: name,
          table_numero: null,
          couleur: color,
          forme: shape,
          url_qr: url
        }]);
        if(error){ console.warn(error); alert("Création en base échouée (plan local créé)."); }
      }

      tableName.value='';
      await loadTableList();
    });

    // ---------- BOOT ----------
    await loadSessionAndRestaurant();
    await renderGeneralQR(false);   // génération initiale
    renderFloor();                  // plan local
    await loadTableList();          // tables

    // ---------- LISTENERS ----------
    window.addEventListener('online', async ()=>{ await loadSessionAndRestaurant(); });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Consentement & Allergies — AllergoZymeProtect / Passport</title>
  <meta name="description" content="Consentement numérique intelligent — Allergènes, intolérances, diabète et identification AllergoZyme Passport." />

  <style>
    :root {
      --gold:#c9a227; --gold-strong:#b68f1e; --white:#ffffff;
      --gold-alpha-25:rgba(201,162,39,0.25); --gold-alpha-45:rgba(201,162,39,0.45);
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:'Segoe UI',system-ui,Arial;background:var(--white);color:var(--gold-strong)}
    .container{max-width:950px;margin:40px auto;padding:32px;border-radius:24px;border:1px solid var(--gold-alpha-45);
      box-shadow:0 20px 60px rgba(201,162,39,0.25);
      background:radial-gradient(circle at 50% 20%, rgba(201,162,39,0.12), transparent 60%), var(--white);
      animation:fadeIn 0.6s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    header{display:flex;align-items:center;justify-content:center;gap:10px;margin-bottom:20px}
    header img{width:52px;height:52px}
    h1{font-size:1.8rem;margin:0;text-align:center;text-shadow:0 0 12px rgba(201,162,39,0.45)}
    .text{background:linear-gradient(180deg,#fff,#fffdf5);border-radius:14px;border:1px solid var(--gold-alpha-25);
      box-shadow:0 0 25px rgba(201,162,39,0.08);padding:22px;font-size:.97rem;color:#704f0b;text-align:justify;line-height:1.7;margin-bottom:24px}
    form{display:grid;gap:16px;margin-top:10px}
    label{font-weight:600}
    input[type="text"],input[type="email"],input[type="password"],input[type="tel"],select,textarea{
      width:100%;padding:12px;border:1px solid var(--gold-alpha-45);border-radius:12px;font-size:1rem;transition:all .2s ease}
    input:focus,textarea:focus,select:focus{outline:none;border-color:var(--gold-strong);box-shadow:0 0 10px rgba(201,162,39,0.25)}
    button{background:var(--gold-strong);color:#fff;border:none;padding:14px;border-radius:999px;font-weight:700;cursor:pointer;transition:all .2s ease}
    button:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(201,162,39,0.45)}
    .section-title{margin-top:24px;text-align:center;font-size:1.2rem;font-weight:700;text-shadow:0 0 10px rgba(201,162,39,0.45)}
    .allergens{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
    .allergen-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--gold-alpha-25);border-radius:10px;background:rgba(255,255,255,0.9)}
    .success{margin-top:20px;text-align:center;background:rgba(201,162,39,0.1);border:1px solid var(--gold-alpha-45);padding:14px;border-radius:12px;font-weight:600;display:none}
    .error{margin-top:8px;color:#b00020;font-weight:700}
    .hint{font-size:.9rem;opacity:.8}
    footer{text-align:center;margin-top:40px;font-size:.85rem;opacity:.7;line-height:1.5}
    .pill{display:inline-block;border:1px solid var(--gold-alpha-45);border-radius:999px;padding:2px 8px;font-size:.8rem;margin-left:6px}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <img src="assets/logo.png" alt="AllergoZymeProtect">
      <h1>Consentement & Allergies — AllergoZymeProtect / Passport</h1>
    </header>

    <div class="text">
      <p><strong>Déclaration officielle et signalement des allergies, intolérances et risques liés au diabète.</strong></p>
      <p>Remplissez ce formulaire pour que l’établissement garantisse votre sécurité alimentaire. Vous pouvez vous connecter avec votre compte <em>AllergoZyme Passport</em> (facultatif) pour pré-remplir vos infos.</p>
      <p class="hint">
        QR relié à l’établissement :
        <span id="qr-info" class="pill">Vérification…</span>
      </p>
      <div id="qr-error" class="error" style="display:none"></div>
    </div>

    <!-- Identification AllergoZyme Passport -->
    <section>
      <h2 class="section-title">Identification AllergoZyme Passport (optionnel)</h2>
      <p style="text-align:center">Déjà un compte Passport ? Connectez-vous pour charger vos informations automatiquement :</p>

      <form id="login-form" autocomplete="on">
        <input type="email" id="login-email" placeholder="Email Passport" required>
        <input type="password" id="login-password" placeholder="Mot de passe" required>
        <button type="submit">S’identifier</button>
      </form>
      <div id="login-status" style="text-align:center;margin-top:10px;font-weight:600;"></div>
    </section>

    <!-- Formulaire principal -->
    <form id="signature-form" autocomplete="on">
      <label for="nom">Nom et prénom</label>
      <input type="text" id="nom" name="nom" placeholder="Votre nom complet" required>

      <label for="contact">E-mail ou numéro de téléphone</label>
      <input type="text" id="contact" name="contact" placeholder="E-mail ou téléphone" required>

      <h2 class="section-title">Sélectionnez vos allergènes / intolérances</h2>
      <div class="allergens" id="allergen-grid">
        <label class="allergen-item"><input type="checkbox" value="Gluten"> Gluten</label>
        <label class="allergen-item"><input type="checkbox" value="Crustacés"> Crustacés</label>
        <label class="allergen-item"><input type="checkbox" value="Oeufs"> Œufs</label>
        <label class="allergen-item"><input type="checkbox" value="Poissons"> Poissons</label>
        <label class="allergen-item"><input type="checkbox" value="Arachides"> Arachides</label>
        <label class="allergen-item"><input type="checkbox" value="Soja"> Soja</label>
        <label class="allergen-item"><input type="checkbox" value="Lait"> Lait</label>
        <label class="allergen-item"><input type="checkbox" value="Fruits à coque"> Fruits à coque</label>
        <label class="allergen-item"><input type="checkbox" value="Céleri"> Céleri</label>
        <label class="allergen-item"><input type="checkbox" value="Moutarde"> Moutarde</label>
        <label class="allergen-item"><input type="checkbox" value="Sésame"> Graines de sésame</label>
        <label class="allergen-item"><input type="checkbox" value="Anhydride sulfureux"> Sulfites</label>
        <label class="allergen-item"><input type="checkbox" value="Lupin"> Lupin</label>
        <label class="allergen-item"><input type="checkbox" value="Mollusques"> Mollusques</label>
        <label class="allergen-item"><input type="checkbox" value="Diabète" data-diabetes> Diabète</label>
      </div>

      <label for="autres">Autres allergies ou intolérances (ex : lactose, histamine...)</label>
      <textarea id="autres" rows="3" placeholder="Indiquez ici d’autres sensibilités ou intolérances..."></textarea>

      <label><input type="checkbox" id="noAllergy"> Je n’ai pas d’allergène connu</label>
      <label><input type="checkbox" id="consent30" required> J’autorise la conservation de mes données 30 jours (puis suppression si je n’ai pas de compte Passport).</label>
      <label><input type="checkbox" id="consent" required> J’ai lu et j’accepte l’ensemble des informations ci-dessus.</label>

      <button type="submit">Valider et signer</button>
      <div id="submit-error" class="error" style="display:none"></div>
    </form>

    <div class="success" id="success-message">
      ✅ Vos informations ont été enregistrées et transmises au restaurateur. Redirection…
    </div>
  </div>

  <footer>
    © AllergoZymeProtect / Passport — Consentement & Allergies.<br />
    Données chiffrées, hébergées dans l’UE. Conservation : 30 jours ou selon compte Passport.
  </footer>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ---------- SUPABASE ----------
    const supabase = createClient(
      "https://tmrraeutjrcsozijjbzm.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtcnJhZXV0anJjc296aWpqYnptIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MDA4NzIsImV4cCI6MjA3NjM3Njg3Mn0.015qUFsUyndsesz5RHGKWO1Ipoz7C3vcVZulACGmq0g"
    );

    // ---------- PARAMS ----------
    const params = new URLSearchParams(window.location.search);
    const restaurantId = params.get("restaurant");
    const table = params.get("table") || "Général";

    // ---------- UI refs ----------
    const loginForm = document.getElementById("login-form");
    const loginStatus = document.getElementById("login-status");
    const form = document.getElementById("signature-form");
    const successMessage = document.getElementById("success-message");
    const submitError = document.getElementById("submit-error");
    const qrInfo = document.getElementById("qr-info");
    const qrError = document.getElementById("qr-error");

    // ---------- Helpers ----------
    const isUUID = (v)=> /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(v||"");
    const setQRBadge = (text, ok=true)=>{
      qrInfo.textContent = text;
      qrInfo.style.borderColor = ok ? "rgba(201,162,39,0.45)" : "#b00020";
      qrInfo.style.color = ok ? "#6f540f" : "#b00020";
    };

    // Affiche état du QR (vendeur/restaurant)
    if (restaurantId && isUUID(restaurantId)) {
      setQRBadge("Établissement relié ✅");
    } else if (restaurantId) {
      setQRBadge("QR démo / non relié", false);
      qrError.style.display = "block";
      qrError.textContent = "Avertissement : identifiant de restaurant invalide. La signature sera enregistrée mais non rattachée.";
    } else {
      setQRBadge("QR sans identifiant", false);
      qrError.style.display = "block";
      qrError.textContent = "Avertissement : ce lien n’indique pas l’établissement. La signature sera enregistrée sans rattachement.";
    }

    // Quand “Aucun allergène” est coché, on décoche les autres (sauf diabète)
    const noAllergy = document.getElementById("noAllergy");
    const allergenGrid = document.getElementById("allergen-grid");
    noAllergy.addEventListener("change",()=>{
      if(noAllergy.checked){
        allergenGrid.querySelectorAll('input[type="checkbox"]:not([data-diabetes])').forEach(cb=> cb.checked = false);
      }
    });
    allergenGrid.addEventListener("change",(e)=>{
      if(e.target.type === "checkbox" && !e.target.hasAttribute("data-diabetes") && e.target.checked){
        noAllergy.checked = false;
      }
    });

    // ---------- LOGIN PASSPORT (optionnel) ----------
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginStatus.textContent = "Connexion…";
      loginStatus.style.color = "#6f540f";

      const email = document.getElementById("login-email").value.trim();
      const password = document.getElementById("login-password").value;

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        loginStatus.style.color = "red";
        loginStatus.textContent = "Erreur d’identification.";
        return;
      }

      // Pré-remplissage depuis la table passports (par contact = email)
      try {
        const { data: pass } = await supabase
          .from("passports")
          .select("contact, allergenes, autres_allergenes, diabete, nom")
          .eq("contact", email)
          .maybeSingle();

        if (pass) {
          document.getElementById("nom").value = pass.nom || "";
          document.getElementById("contact").value = pass.contact || email;
          document.getElementById("autres").value = pass.autres_allergenes || "";

          // coches
          const mapVals = (pass.allergenes||"").split(",").map(s=>s.trim()).filter(Boolean);
          allergenGrid.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
            cb.checked = mapVals.includes(cb.value);
          });
          // diabète bool
          const diabCb = allergenGrid.querySelector('input[data-diabetes]');
          if (diabCb) diabCb.checked = !!pass.diabete;
        }
      } catch(e) {
        // silencieux
      }

      loginStatus.style.color = "green";
      loginStatus.textContent = "Connecté — infos synchronisées.";
    });

    // ---------- INSERT SIGNATURE ----------
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      submitError.style.display = "none";
      successMessage.style.display = "none";

      const nom = form.nom.value.trim();
      const contact = form.contact.value.trim();
      const autres = document.getElementById("autres").value.trim();
      const checked = Array.from(document.querySelectorAll('.allergen-item input:checked'));
      const allergenesList = checked.filter(cb=>!cb.hasAttribute('data-diabetes')).map(cb=>cb.value);
      const diabetesChecked = checked.some(cb=> cb.hasAttribute('data-diabetes'));
      const noAllergyChecked = document.getElementById("noAllergy").checked;

      const payload = {
        restaurant_id:restaurantId,
        table_ref: table,
        nom_client: nom,
        emailnumero_client: contact,
        allergenes: noAllergyChecked ? "Aucun" : allergenesList.join(", "),
        autres_allergenes: autres,
        diabete: diabetesChecked,
        consentement: true
      };

      try{
        // on veut récupérer l'id inséré pour la redirection
        const { data, error } = await supabase
          .from("signatures")
          .insert([payload])
          .select("id")
          .single();

        if (error) {
          submitError.style.display = "block";
          submitError.textContent = "Erreur d’enregistrement : " + (error.message || "inconnue");
          return;
        }

        successMessage.style.display = "block";

        // Redirection vers page de validation
        const sid = data?.id || "";
        const url = new URL("validesignature.html", window.location.origin);
        url.searchParams.set("ok","1");
        if (sid) url.searchParams.set("sid", sid);
        if (restaurantId) url.searchParams.set("restaurant", restaurantId);
        if (table) url.searchParams.set("table", table);
        window.location.href = url.toString();
      }catch(err){
        submitError.style.display = "block";
        submitError.textContent = "Erreur réseau ou navigateur. Veuillez réessayer.";
      }
    });
  </script>
</body>
</html>
